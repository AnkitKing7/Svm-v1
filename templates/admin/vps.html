{% extends "base.html" %}
{% block title %}Manage VPS - {{ settings.panel_name }}{% endblock %}
{% block content %}
<div class="main-container">
    <nav class="sidebar">
        <div class="sidebar-header">
            {% if settings.logo %}
            <img src="{{ settings.logo }}" alt="Logo" class="sidebar-logo">
            {% else %}
            <i class="fas fa-server sidebar-icon"></i>
            {% endif %}
            <h2>{{ settings.panel_name }}</h2>
        </div>

        <ul class="sidebar-menu">
            <li>
                <a href="{{ url_for('dashboard') }}">
                    <i class="fas fa-home"></i> User Dashboard
                </a>
            </li>
            <li>
                <a href="{{ url_for('admin_panel') }}">
                    <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                </a>
            </li>
            <li>
                <a href="{{ url_for('admin_users') }}">
                    <i class="fas fa-users"></i> Manage Users
                </a>
            </li>
            <li class="active">
                <a href="{{ url_for('admin_vps') }}">
                    <i class="fas fa-server"></i> Manage VPS
                </a>
            </li>
            <li>
                <a href="{{ url_for('admin_payments') }}">
                    <i class="fas fa-money-bill-wave"></i> Payments
                </a>
            </li>
            <li>
                <a href="{{ url_for('admin_settings') }}">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </li>
            <li>
                <a href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </nav>

    <div class="main-content">
        <div class="top-bar">
            <div class="welcome-message">
                <h1><i class="fas fa-server"></i> Manage VPS</h1>
                <p>View and control all VPS instances</p>
            </div>
            <div class="uptime-display">
                <i class="fas fa-clock"></i> {{ uptime }}
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-server"></i>
                </div>
                <div class="stat-info">
                    <h3>Total VPS</h3>
                    <p class="stat-value">{{ total_vps }}</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-play-circle"></i>
                </div>
                <div class="stat-info">
                    <h3>Running</h3>
                    <p class="stat-value">{{ running_vps }}</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="fas fa-pause-circle"></i>
                </div>
                <div class="stat-info">
                    <h3>Stopped/Suspended</h3>
                    <p class="stat-value">{{ stopped_vps }}</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon purple">
                    <i class="fas fa-memory"></i>
                </div>
                <div class="stat-info">
                    <h3>Total RAM</h3>
                    <p class="stat-value">{{ total_ram }} GB</p>
                </div>
            </div>
        </div>

        <div class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-plus-circle"></i> Create New VPS</h2>
            </div>
            <form method="POST" action="{{ url_for('admin_vps') }}" class="admin-form">
                <input type="hidden" name="action" value="create">
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Select User</label>
                        <select name="username" required>
                            <option value="">Choose user...</option>
                            {% for username, user in users.items() %}
                            <option value="{{ username }}">{{ user.username }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> VPS Name</label>
                        <input type="text" name="vps_name" required placeholder="my-vps-server" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-box"></i> Plan</label>
                        <select name="plan" required>
                            <option value="starter">ðŸ”° Starter (4GB RAM, 2 CPU)</option>
                            <option value="basic">âš¡ Basic (8GB RAM, 4 CPU)</option>
                            <option value="pro">ðŸš€ Pro (16GB RAM, 8 CPU)</option>
                            <option value="premium">ðŸ’Ž Premium (32GB RAM, 16 CPU)</option>
                            <option value="ultimate">ðŸ‘‘ Ultimate (64GB RAM, 12 CPU)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-hdd"></i> Disk (GB)</label>
                        <input type="number" name="disk" required value="50" min="20" max="500">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-desktop"></i> OS Template</label>
                        <select name="os" required>
                            <option value="ubuntu-22.04">Ubuntu 22.04 LTS</option>
                            <option value="ubuntu-20.04">Ubuntu 20.04 LTS</option>
                            <option value="debian-11">Debian 11</option>
                            <option value="centos-8">CentOS 8</option>
                            <option value="rocky-8">Rocky Linux 8</option>
                            <option value="windows-server-2022">Windows Server 2022 (Experimental)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-key"></i> Root Password</label>
                        <input type="password" name="root_password" required placeholder="Strong password (min 6 chars)" minlength="6">
                        <small class="form-help">Password will be set for root user.</small>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create VPS
                </button>
            </form>
        </div>

        <div class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> All VPS Instances ({{ vps_list|length }})</h2>
                <div class="filter-group">
                    <select id="statusFilter" onchange="filterVPS()" class="filter-select">
                        <option value="all">All Status</option>
                        <option value="running">Running</option>
                        <option value="stopped">Stopped/Suspended</option>
                    </select>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="vpsSearch" placeholder="Search VPS..." onkeyup="filterVPS()">
                    </div>
                </div>
            </div>

            <div class="vps-grid">
                {% for vps in vps_list %}
                <div class="vps-card" data-status="{{ 'suspended' if vps.suspended else vps.status }}" data-search="{{ vps.name|lower }} {{ vps.owner|lower }} {{ vps.os|lower }}">
                    <div class="vps-header">
                        <div class="vps-title">
                            <h3><i class="fas fa-server"></i> {{ vps.name }}</h3>
                            {% if vps.suspended %}
                            <span class="status-badge suspended"><i class="fas fa-circle"></i> Suspended</span>
                            {% elif vps.status == 'running' %}
                            <span class="status-badge running"><i class="fas fa-circle"></i> Running</span>
                            {% else %}
                            <span class="status-badge stopped"><i class="fas fa-circle"></i> Stopped</span>
                            {% endif %}
                        </div>
                        <div class="vps-id">VM-{{ vps.vm_id }}</div>
                    </div>

                    <div class="vps-info">
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <span>Owner: <strong>{{ vps.owner }}</strong></span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-desktop"></i>
                            <span>OS: <strong>{{ vps.os }}</strong></span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-network-wired"></i>
                            <span>IP: <strong>{{ vps.ip }}</strong></span>
                        </div>
                    </div>

                    <div class="vps-specs">
                        <div class="spec-item">
                            <i class="fas fa-memory"></i>
                            <span>{{ vps.ram }} RAM</span>
                        </div>
                        <div class="spec-item">
                            <i class="fas fa-microchip"></i>
                            <span>{{ vps.cpu }} Cores</span>
                        </div>
                        <div class="spec-item">
                            <i class="fas fa-hdd"></i>
                            <span>{{ vps.disk.replace('GB', '') }} GB</span>
                        </div>
                    </div>

                    <div class="vps-actions">
                        {% if vps.status == 'running' and not vps.suspended %}
                        <button class="btn-action btn-stop" onclick="controlVPS('{{ vps.vm_id }}', 'stop')">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <button class="btn-action btn-restart" onclick="controlVPS('{{ vps.vm_id }}', 'restart')">
                            <i class="fas fa-redo"></i> Restart
                        </button>
                        {% else %}
                        <button class="btn-action btn-start" onclick="controlVPS('{{ vps.vm_id }}', 'start')">
                            <i class="fas fa-play"></i> Start
                        </button>
                        {% endif %}
                        <button class="btn-action btn-reinstall" onclick="controlVPS('{{ vps.vm_id }}', 'reinstall')">
                            <i class="fas fa-sync-alt"></i> Reinstall
                        </button>
                        <button class="btn-action btn-ssh" onclick="generateSSH('{{ vps.vm_id }}', '{{ vps.name }}')">
                            <i class="fas fa-terminal"></i> SSH Access
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteVPS('{{ vps.vm_id }}', '{{ vps.name }}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.filter-group {
    display: flex;
    gap: 15px;
    align-items: center;
}

.filter-select {
    padding: 10px 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.vps-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.vps-card {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s;
}

.vps-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border-color: var(--accent-blue);
}

.vps-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.vps-title {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.vps-title h3 {
    font-size: 18px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.vps-title h3 i {
    color: var(--accent-blue);
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-badge.running {
    background: rgba(46, 204, 113, 0.2);
    color: var(--accent-green);
}

.status-badge.stopped {
    background: rgba(231, 76, 60, 0.2);
    color: var(--accent-red);
}

.status-badge.suspended {
    background: rgba(149, 165, 166, 0.2);
    color: #95a5a6;
}

.status-badge i {
    font-size: 8px;
}

.vps-id {
    background: var(--bg-secondary);
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 12px;
    color: var(--text-secondary);
    font-family: monospace;
}

.vps-info {
    margin: 15px 0;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    color: var(--text-secondary);
    font-size: 14px;
}

.info-item i {
    color: var(--accent-blue);
    width: 20px;
}

.vps-specs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin: 15px 0;
    padding: 15px 0;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
}

.spec-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 5px;
}

.spec-item i {
    font-size: 20px;
    color: var(--accent-blue);
}

.spec-item span {
    font-size: 12px;
    color: var(--text-secondary);
}

.vps-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
}

.btn-action {
    flex: 1 1 45%; /* Allow wrapping on small screens */
    min-width: 100px;
    padding: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.3s;
}

.btn-start {
    background: rgba(46, 204, 113, 0.2);
    color: var(--accent-green);
}

.btn-start:hover {
    background: var(--accent-green);
    color: white;
}

.btn-stop {
    background: rgba(231, 76, 60, 0.2);
    color: var(--accent-red);
}

.btn-stop:hover {
    background: var(--accent-red);
    color: white;
}

.btn-restart {
    background: rgba(243, 156, 18, 0.2);
    color: var(--accent-orange);
}

.btn-restart:hover {
    background: var(--accent-orange);
    color: white;
}

.btn-reinstall {
    background: rgba(52, 152, 219, 0.2);
    color: var(--accent-blue);
}

.btn-reinstall:hover {
    background: var(--accent-blue);
    color: white;
}

.btn-ssh {
    background: rgba(155, 89, 182, 0.2);
    color: var(--accent-purple);
}

.btn-ssh:hover {
    background: var(--accent-purple);
    color: white;
}

.btn-delete {
    background: rgba(231, 76, 60, 0.2);
    color: var(--accent-red);
}

.btn-delete:hover {
    background: var(--accent-red);
    color: white;
}

.form-help {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 2px;
}
</style>

<script>
function filterVPS() {
    const statusFilter = document.getElementById('statusFilter').value;
    const searchInput = document.getElementById('vpsSearch').value.toLowerCase();
    const cards = document.querySelectorAll('.vps-card');

    cards.forEach(card => {
        const status = card.getAttribute('data-status');
        const searchText = card.getAttribute('data-search');
        
        const statusMatch = statusFilter === 'all' || status === statusFilter;
        const searchMatch = searchText.includes(searchInput);
        
        card.style.display = (statusMatch && searchMatch) ? 'block' : 'none';
    });
}

function controlVPS(vmId, action) {
    if (confirm(`Are you sure you want to ${action} this VPS? This may take a few minutes for reinstall.`)) {
        const formData = new FormData();
        formData.append('action', 'control');
        formData.append('vm_id', vmId);
        formData.append('control', action);
        
        fetch('{{ url_for("admin_vps") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (action === 'reinstall') {
                    alert('Reinstall completed! New root password: ' + data.new_password || 'Check logs');
                }
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => alert('Request failed: ' + err));
    }
}

function deleteVPS(vmId, name) {
    if (confirm(`Are you sure you want to DELETE VPS "${name}"? This action cannot be undone!`)) {
        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('vm_id', vmId);
        
        fetch('{{ url_for("admin_vps") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => alert('Request failed: ' + err));
    }
}

function generateSSH(vmId, name) {
    if (confirm(`Generate SSH access for "${name}"?`)) {
        const formData = new FormData();
        formData.append('action', 'ssh');
        formData.append('vm_id', vmId);
        
        fetch('{{ url_for("admin_vps") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                navigator.clipboard.writeText(data.ssh_url).then(() => {
                    alert('SSH URL copied to clipboard: ' + data.ssh_url);
                }).catch(() => {
                    prompt('SSH Access URL:', data.ssh_url);
                });
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => alert('Request failed: ' + err));
    }
}
</script>
{% endblock %}
